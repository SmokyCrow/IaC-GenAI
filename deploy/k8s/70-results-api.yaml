apiVersion: apps/v1
kind: Deployment
metadata:
  name: results-api
  namespace: semseg
spec:
  replicas: 1
  selector:
    matchLabels:
      app: results-api
  template:
    metadata:
      labels:
        app: results-api
    spec:
      containers:
        - name: results-api
          image: semantic-segmenter:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: SEGMENTS_DIR
              value: "/segments"
            - name: REDIS_URL
              value: "redis://redis.semseg.svc.cluster.local:6379/0"
            - name: REDIS_STREAM_FRAMES_CONVERTED
              value: "s_frames_converted"
            - name: REDIS_STREAM_PARTS_LABELED
              value: "s_parts_labeled"
            - name: REDIS_STREAM_REDACTED_DONE
              value: "s_redacted_done"
            - name: REDIS_STREAM_ANALYTICS_DONE
              value: "s_analytics_done"
          ports:
            - containerPort: 8081
          command: ["bash", "-lc"]
          args:
            - >-
              uvicorn services.results_api.app:app --host 0.0.0.0 --port 8081 --workers 1
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8081
            initialDelaySeconds: 3
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8081
            initialDelaySeconds: 10
            periodSeconds: 10
          volumeMounts:
            - name: seg
              mountPath: /segments
      volumes:
        - name: seg
          persistentVolumeClaim:
            claimName: segments-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: results-api
  namespace: semseg
spec:
  selector:
    app: results-api
  type: NodePort
  ports:
    - port: 80
      targetPort: 8081
      nodePort: 30081
